<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha RPG</title>
    <link rel="stylesheet" href="stilus.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A0A1F">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <link rel="icon" type="image/png" href="icon-192.png">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

    <div id="login-modal" class="modal-overlay" style="display: flex;">
        <div class="modal-content" style="max-width: 350px;">
            <h2 id="login-title">Acesso RPG</h2>
            <input type="email" id="email-input" class="inv-input" placeholder="E-mail" style="width: 100%; margin-bottom: 10px;">
            <input type="password" id="senha-input" class="inv-input" placeholder="Senha" style="width: 100%; margin-bottom: 20px;">
            <button onclick="fazerLogin()" class="mod-btn" style="width: 100%; margin-bottom: 5px; border-color: var(--cor-destaque);">Entrar</button>
            <button onclick="criarConta()" class="mod-btn" style="width: 100%; border-color: var(--cor-sucesso);">Criar Conta</button>
            <p id="msg-erro" style="color: var(--cor-perigo); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="nuvem-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 600px;">
            <h3>Minhas Fichas na Nuvem</h3>
            <div id="lista-fichas-nuvem" style="max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px;">
                <p style="color: #aaa;">Carregando...</p>
            </div>
            <div class="modal-buttons">
                <button onclick="fecharModalNuvem()" class="mod-btn">Fechar</button>
                <button onclick="salvarNovaFichaNuvem()" class="mod-btn" style="border-color: var(--cor-destaque); color: var(--cor-destaque);">‚òÅÔ∏è Salvar Atual</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Ficha de Personagem</h1>

        <div class="header-split-container">
            
            <div class="status-box header-avatar-box">
                <div class="avatar-wrapper">
                    <img id="char-image-display" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzFDMUMzQSIgc3Ryb2tlPSIjMDBGRkZGIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI0Ii8+PHBhdGggZD0iTTQgMjF2LTFhNCA0IDAgMCAxIDQtNGg4YTQgNCAwIDAgMSA0IDR2MSIvPjwvc3ZnPg==" alt="Avatar" onclick="document.getElementById('char-image-upload').click()">
                    <div class="avatar-overlay" onclick="document.getElementById('char-image-upload').click()">üì∑</div>
                </div>
                <input type="file" id="char-image-upload" accept="image/*" onchange="carregarImagemPersonagem(event)">
            </div>

            <div class="status-box header-info-box">
                <div class="nome-input-group" style="margin-bottom: 10px;">
                    <input type="text" id="nome-personagem-input" placeholder="NOME DO PERSONAGEM" style="width: 100%; font-size: 1.4rem; height: 40px;">
                    
                    <div class="dropdown-menu-container">
                        <button onclick="toggleMenu()" class="mod-btn menu-btn" style="height: 40px; width: 30px; display: flex; align-items: center; justify-content: center;">‚ãÆ</button>
                        <div id="menu-dropdown" class="dropdown-content">
                            <a href="#" onclick="baixarFicha()">üíæ Baixar Ficha</a>
                            <a href="#" onclick="document.getElementById('upload-json').click()">üìÇ Carregar Ficha</a>
                            <a href="#" onclick="abrirModalNuvem()">‚òÅÔ∏è Salvar na Nuvem</a>
                            <a href="#" onclick="gerarPDF()">üìÑ Exportar PDF</a>
                            <hr style="border-color: #444; margin: 5px 0;">
                            <a href="#" onclick="fazerLogout()" style="color: var(--cor-perigo);">‚ùå Sair</a>
                        </div>
                        <input type="file" id="upload-json" style="display: none;" accept=".json" onchange="carregarFicha(event)">
                    </div>
                </div>

                <div class="header-info-row">
                    <div class="info-group">
                        <label>Talento</label>
                        <textarea id="cabecalho-talento" class="auto-resize" rows="1"></textarea>
                    </div>
                    <div class="info-group">
                        <label>Ascens√£o</label>
                        <textarea id="cabecalho-ascensao" class="auto-resize" rows="1"></textarea>
                    </div>
                    <div class="info-group">
                        <label>Racial</label>
                        <textarea id="cabecalho-racial" class="auto-resize" rows="1"></textarea>
                    </div>
                    <div class="info-group" style="flex: 2;">
                        <label>Info</label>
                        <textarea id="cabecalho-info" class="auto-resize" rows="1"></textarea>
                    </div>
                </div>
            </div>
        </div>

       <div class="recurso-box-container">
            <div class="recurso-row">
                <div class="rec-header"><span>HP</span><span class="rec-values"><span id="hp-atual">0</span>/<span id="hp-max">0</span></span></div>
                <div class="rec-bar-container"><div id="hp-bar-fill" class="rec-bar-fill hp-fill"></div></div>
                <div class="rec-controls">
                    <input type="number" id="mod-hp" class="rec-input" placeholder="Qtd">
                    <button class="rec-btn-mini rec-btn-danger" onclick="alterarRecurso('hp', -1)">-</button>
                    <button class="rec-btn-mini rec-btn-success" onclick="alterarRecurso('hp', 1)">+</button>
                </div>
            </div>
            <div class="recurso-row">
                <div class="rec-header"><span>ST</span><span class="rec-values"><span id="st-atual">0</span>/<span id="st-max">0</span></span></div>
                <div class="rec-bar-container"><div id="st-bar-fill" class="rec-bar-fill st-fill"></div></div>
                <div class="rec-controls">
                    <input type="number" id="mod-st" class="rec-input">
                    <button class="rec-btn-mini rec-btn-danger" onclick="alterarRecurso('st', -1)">-</button>
                    <button class="rec-btn-mini rec-btn-success" onclick="alterarRecurso('st', 1)">+</button>
                </div>
            </div>
            <div class="recurso-row">
                <div class="rec-header"><span>MP</span><span class="rec-values"><span id="mp-atual">0</span>/<span id="mp-max">0</span></span></div>
                <div class="rec-bar-container"><div id="mp-bar-fill" class="rec-bar-fill mp-fill"></div></div>
                <div class="rec-controls">
                    <input type="number" id="mod-mp" class="rec-input">
                    <button class="rec-btn-mini rec-btn-danger" onclick="alterarRecurso('mp', -1)">-</button>
                    <button class="rec-btn-mini rec-btn-success" onclick="alterarRecurso('mp', 1)">+</button>
                </div>
            </div>
            <div class="recurso-row">
                <div class="rec-header"><span>PSI</span><span class="rec-values"><span id="psi-atual">0</span>/<span id="psi-max">0</span></span></div>
                <div class="rec-bar-container"><div id="psi-bar-fill" class="rec-bar-fill psi-fill"></div></div>
                <div class="rec-controls">
                    <input type="number" id="mod-psi" class="rec-input">
                    <button class="rec-btn-mini rec-btn-danger" onclick="alterarRecurso('psi', -1)">-</button>
                    <button class="rec-btn-mini rec-btn-success" onclick="alterarRecurso('psi', 1)">+</button>
                </div>
            </div>
        </div>

        <div class="flex-container">
            <div class="col-left">
                
                <div class="status-box">
                    <div class="tabs-principal">
                        <button class="tab-principal-btn active" onclick="mudarAbaPrincipal('atributos')">Atributos</button>
                        <button class="tab-principal-btn" onclick="mudarAbaPrincipal('batalha')">Batalha</button>
                        <button class="tab-principal-btn" onclick="mudarAbaPrincipal('radar')">Radar</button>
                    </div>

                    <div id="view-atributos" class="tab-content-principal" style="display: block;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 10px;">
                            <h3>Base</h3>
                            <div style="font-size: 0.85rem; color: #aaa;">
                                N√≠vel: <span id="nivel-display" style="color: var(--cor-destaque); font-weight: bold;">0.00</span> | 
                                Pontos: <span id="total-pontos">0</span>
                            </div>
                        </div>
                        
                        <div class="atributo-row" data-nome="Forca"><label>For√ßa</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Destreza"><label>Destreza</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Agilidade"><label>Agilidade</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Resistencia"><label>Resist√™ncia</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Esp√≠rito"><label>Esp√≠rito</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Carisma"><label>Carisma</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                        
                        <div class="atributo-row" data-nome="Inteligencia"><label>Intelig√™ncia</label><div class="atributo-input-group"><button class="mod-btn compact-btn" onclick="decrementAttr(this)">-</button><input type="number" class="atributo-input" value="1" min="0" readonly><button class="mod-btn compact-btn" onclick="incrementAttr(this)">+</button></div><div class="treino-info"><span class="msg-status"></span> Treino: <span class="treino-contador">0</span>/<span class="atributo-valor-display">1</span> <button class="treinar-btn" onclick="gerenciarClickTreino(this)">Treinar</button></div></div>
                    </div>

                    <div id="view-batalha" class="tab-content-principal" style="display: none; padding-top: 10px;">
                        <h3 style="margin-bottom:10px; text-align:center;">Status de Combate</h3>
                        
                        <div class="battle-grid">
                            <div class="battle-group"><label>Esquiva</label><input type="text" class="batalha-input" data-id="esquiva"></div>
                            <div class="battle-group"><label>Defesa Fisica</label><input type="text" class="batalha-input" data-id="defesa_fisica"></div>
                            <div class="battle-group"><label>Acerto Fisica</label><input type="text" class="batalha-input" data-id="acerto_fisica"></div>
                            
                            <div class="battle-group"><label>Aparo</label><input type="text" class="batalha-input" data-id="aparo"></div>
                            <div class="battle-group"><label>Defesa Perf/Cont</label><input type="text" class="batalha-input" data-id="defesa_perf_cont"></div>
                            <div class="battle-group"><label>Acerto Proj√©til</label><input type="text" class="batalha-input" data-id="acerto_projetil"></div>
                            
                            <div class="battle-group"><label>Resist√™ncia M√°gica</label><input type="text" class="batalha-input" data-id="resistencia_mag"></div>
                            <div class="battle-group"><label>Defesa M√°gica</label><input type="text" class="batalha-input" data-id="defesa_magica"></div>
                            <div class="battle-group"><label>Acerto Feiti√ßo</label><input type="text" class="batalha-input" data-id="acerto_feiti√ßo"></div>

                            <div class="battle-group"><label>Resist√™ncia Ps√≠quica</label><input type="text" class="batalha-input" data-id="resistencia_psiquica"></div>
                            <div class="battle-group"><label>Defesa Ps√≠quica</label><input type="text" class="batalha-input" data-id="defesa_psiquica"></div>
                            <div class="battle-group"><label>Acerto Ps√≠quico</label><input type="text" class="batalha-input" data-id="acerto_psiquico"></div>

                            <div class="battle-group"><label>Resist√™ncia Fisica</label><input type="text" class="batalha-input" data-id="resistencia_fisica"></div>
                            <div class="battle-group"><label>Defesa Real</label><input type="text" class="batalha-input" data-id="defesa_real"></div>
                            <div class="battle-group"><label>Acerto Controle</label><input type="text" class="batalha-input" data-id="acerto_controle"></div>

                            <div class="battle-group"><label>Iniciativa</label><input type="text" class="batalha-input" data-id="Iniciativa"></div>
                        </div>
                    </div>

                    <div id="view-radar" class="tab-content-principal" style="display: none; text-align: center; padding-top: 10px;">
                        <h3>Radar de Poder</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="graficoAtributos"></canvas>
                        </div>
                    </div>

                </div>

                <div class="status-box">
                    <h3>Per√≠cias</h3>
                    <div class="pericia-header-editavel"><span class="pericia-icone">ü•á</span> <input type="text" id="titulo-principal" class="pericia-titulo-input" value="Per√≠cias Principais"> <span style="font-size: 0.8rem; color: #888;">(<span id="pericia-principal-gastos">0</span>/<span id="pericia-principal-pts">0</span>)</span></div>
                    <div id="pericias-principal"></div>
                    <button onclick="adicionarPericia('principal')" class="mod-btn compact-btn" style="width:100%; margin-top:5px;">+ Adicionar</button>

                    <div class="pericia-header-editavel"><span class="pericia-icone">ü•à</span> <input type="text" id="titulo-secundaria" class="pericia-titulo-input" value="Per√≠cias Secund√°rias"> <span style="font-size: 0.8rem; color: #888;">(<span id="pericia-secundaria-gastos">0</span>/<span id="pericia-secundaria-pts">0</span>)</span></div>
                    <div id="pericias-secundaria"></div>
                    <button onclick="adicionarPericia('secundaria')" class="mod-btn compact-btn" style="width:100%; margin-top:5px;">+ Adicionar</button>

                    <div class="pericia-header-editavel"><span class="pericia-icone">ü•â</span> <input type="text" id="titulo-terciaria" class="pericia-titulo-input" value="Per√≠cias Terci√°rias"> <span style="font-size: 0.8rem; color: #888;">(<span id="pericia-terciaria-gastos">0</span>/<span id="pericia-terciaria-pts">0</span>)</span></div>
                    <div id="pericias-terciaria"></div>
                    <button onclick="adicionarPericia('terciaria')" class="mod-btn compact-btn" style="width:100%; margin-top:5px;">+ Adicionar</button>
                </div>
            </div>

            <div class="col-right">
                
                <div class="status-box">
                    <div style="margin-bottom: 10px; border-bottom: 1px solid var(--cor-borda-escura); padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; border: none; padding: 0;">Skills</h2>
                        <select id="filter-raridade" class="skill-select" onchange="organizarSkillsVisualmente()" style="width: auto; font-size: 0.8rem; background-color: rgba(0,0,0,0.3);">
                            <option value="Todas">Todas</option>
                            <option value="Comum">Comum</option>
                            <option value="Incomum">Incomum</option>
                            <option value="Raro">Raro</option>
                            <option value="Rar√≠ssima">Rar√≠ssima</option>
                            <option value="√âpico">√âpico</option>
                            <option value="Lend√°rio">Lend√°rio</option>
                            <option value="M√≠tico">M√≠tico</option>
                        </select>
                        <span id="skills-gastos" style="display:none;">0</span>
                    </div>

                    <div class="skill-tabs">
                        <button id="tab-btn-ST" class="skill-tab-btn active" onclick="mudarAbaSkills('ST')">ST <span class="tab-count">[0]</span></button>
                        <button id="tab-btn-MP" class="skill-tab-btn" onclick="mudarAbaSkills('MP')">MP <span class="tab-count">[0]</span></button>
                        <button id="tab-btn-PSI" class="skill-tab-btn" onclick="mudarAbaSkills('PSI')">PSI <span class="tab-count">[0]</span></button>
                    </div>

                    <div class="sub-skill-tabs" style="display: flex; gap: 5px; margin-bottom: 15px; justify-content: center;">
                        <button class="sub-tab-btn active" onclick="mudarSubAba('A')">Ativas</button>
                        <button class="sub-tab-btn" onclick="mudarSubAba('P')">Passivas</button>
                    </div>

                    <div id="skills-view-area">
                        <div id="container-visualizacao"></div>
                    </div>
                    <div id="skills-storage" style="display: none;"></div>
                    <button onclick="adicionarSkill()" class="mod-btn" style="width: 100%; margin-top: 15px;">+ Nova Skill</button>
                </div>

                <div class="status-box">
                    <div style="margin-bottom: 10px; border-bottom: 1px solid var(--cor-borda-escura); padding-bottom: 5px;">
                        <h2 style="margin: 0; border: none; padding: 0;">Invent√°rio</h2>
                    </div>

                    <div class="inv-form-header">
                        <div style="flex-grow: 1;">
                            <div style="display: flex; gap: 5px;">
                                <select id="inv-categoria" class="inv-input">
                                    <option value="item">Item</option>
                                    <option value="arma">Arma</option>
                                    <option value="armadura">Armadura</option>
                                </select>
                                <select id="inv-raridade" class="inv-input">
                                    <option value="Comum">Comum</option>
                                    <option value="Incomum">Incomum</option>
                                    <option value="Raro">Raro</option>
                                    <option value="Rar√≠ssima">Rar√≠ssima</option>
                                    <option value="√âpico">√âpico</option>
                                    <option value="Lend√°rio">Lend√°rio</option>
                                    <option value="M√≠tico">M√≠tico</option>
                                </select>
                                <input type="number" id="inv-qtd" class="inv-input" value="1" min="1" placeholder="Qtd" style="width: 60px;">
                            </div>
                            <input type="text" id="inv-nome" class="inv-input" placeholder="Nome do Item" style="width: 100%; margin-top: 5px;">
                            <div id="inv-campo-extra" style="margin-top: 5px;"></div>
                            <textarea id="inv-desc" class="inv-input" rows="2" placeholder="Descri√ß√£o do Item..." style="width: 100%; margin-top: 5px;"></textarea>
                            <button onclick="adicionarItemInventario()" class="mod-btn adicionar-inv-btn" style="width: 100%; margin-top: 5px;">üì• Adicionar</button>
                        </div>
                    </div>
                    <div id="inventario-container"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="cropper-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Ajustar Imagem</h3>
            <div class="img-container-crop">
                <img id="image-to-crop" src="" alt="Imagem para recortar">
            </div>
            <div class="modal-buttons">
                <button onclick="cancelarRecorte()" class="mod-btn" style="border-color: var(--cor-perigo); color: var(--cor-perigo);">Cancelar</button>
                <button onclick="confirmarRecorte()" class="mod-btn" style="border-color: var(--cor-sucesso); color: var(--cor-sucesso);">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="dice-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="rolarD20()" class="mod-btn" style="border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem; background: var(--cor-header-box); border: 2px solid var(--cor-destaque); box-shadow: 0 0 10px var(--cor-destaque);">üé≤</button>
    </div>

    <script src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service Worker registrado!', reg))
                    .catch((err) => console.log('Erro ao registrar SW:', err));
            });
        }
    </script>
</body>
</html>